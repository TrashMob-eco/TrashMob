# Monitors changes to privacy-related files and creates a GitHub issue
# reminding the team to update App Store / Play Store privacy forms.
#
# Triggers on PRs that modify:
#   - PrivacyInfo.xcprivacy (iOS privacy manifest)
#   - Info.plist (iOS permissions)
#   - AndroidManifest.xml (Android permissions)
#   - PRIVACY_MANIFEST.md (privacy documentation)
#   - Any new SDK/NuGet additions that might collect data

name: Privacy Manifest Check

on:
  pull_request:
    paths:
      - 'TrashMobMobile/Platforms/iOS/PrivacyInfo.xcprivacy'
      - 'TrashMobMobile/Platforms/iOS/Info.plist'
      - 'TrashMobMobile/Platforms/MacCatalyst/PrivacyInfo.xcprivacy'
      - 'TrashMobMobile/Platforms/Android/AndroidManifest.xml'
      - 'Planning/PRIVACY_MANIFEST.md'
      - 'TrashMobMobile/TrashMobMobile.csproj'

permissions:
  issues: write
  contents: read
  pull-requests: write

jobs:
  check-privacy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect privacy-related changes
        id: detect
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          echo "Comparing $BASE...$HEAD"
          echo ""

          CHANGES=""
          SEVERITY="info"

          # Check PrivacyInfo.xcprivacy
          if git diff --name-only "$BASE" "$HEAD" | grep -q 'PrivacyInfo.xcprivacy'; then
            echo "⚠️  PrivacyInfo.xcprivacy changed"
            CHANGES="${CHANGES}\n- **PrivacyInfo.xcprivacy** modified — update Apple App Privacy nutrition label if new API categories were added"
            SEVERITY="warning"
          fi

          # Check Info.plist (new permissions)
          if git diff --name-only "$BASE" "$HEAD" | grep -q 'Info.plist'; then
            PLIST_DIFF=$(git diff "$BASE" "$HEAD" -- '**/Info.plist' || true)
            if echo "$PLIST_DIFF" | grep -qE 'NSCamera|NSPhoto|NSLocation|NSMicrophone|NSContacts'; then
              echo "⚠️  Info.plist permission change detected"
              CHANGES="${CHANGES}\n- **Info.plist** — iOS permission usage descriptions changed. Update App Store privacy form if new permissions were added"
              SEVERITY="warning"
            fi
          fi

          # Check AndroidManifest.xml (new permissions)
          if git diff --name-only "$BASE" "$HEAD" | grep -q 'AndroidManifest.xml'; then
            MANIFEST_DIFF=$(git diff "$BASE" "$HEAD" -- '**/AndroidManifest.xml' || true)
            if echo "$MANIFEST_DIFF" | grep -qE 'uses-permission|ACCESS_|CAMERA|READ_|WRITE_|RECORD_'; then
              echo "⚠️  AndroidManifest.xml permission change detected"
              CHANGES="${CHANGES}\n- **AndroidManifest.xml** — Android permissions changed. Update Google Play Data Safety form if new permissions were added"
              SEVERITY="warning"
            fi
          fi

          # Check for new NuGet packages (potential new SDKs collecting data)
          if git diff --name-only "$BASE" "$HEAD" | grep -q 'TrashMobMobile.csproj'; then
            CSPROJ_DIFF=$(git diff "$BASE" "$HEAD" -- 'TrashMobMobile/TrashMobMobile.csproj' || true)
            if echo "$CSPROJ_DIFF" | grep -qE '^\+.*<PackageReference'; then
              echo "ℹ️  New NuGet packages added to mobile project"
              CHANGES="${CHANGES}\n- **TrashMobMobile.csproj** — New NuGet packages added. Check if any new SDKs collect user data and update PRIVACY_MANIFEST.md"
            fi
          fi

          # Check PRIVACY_MANIFEST.md
          if git diff --name-only "$BASE" "$HEAD" | grep -q 'PRIVACY_MANIFEST.md'; then
            echo "ℹ️  PRIVACY_MANIFEST.md updated"
            CHANGES="${CHANGES}\n- **PRIVACY_MANIFEST.md** — Privacy documentation updated. Ensure App Store and Play Store forms match"
          fi

          if [ -n "$CHANGES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "severity=$SEVERITY" >> $GITHUB_OUTPUT
            echo "changes<<EOF" >> $GITHUB_OUTPUT
            echo -e "$CHANGES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No privacy-impacting changes detected."
          fi

      - name: Add PR comment
        if: steps.detect.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changes = `${{ steps.detect.outputs.changes }}`;
            const severity = `${{ steps.detect.outputs.severity }}`;

            const icon = severity === 'warning' ? ':warning:' : ':information_source:';

            const body = `## ${icon} Privacy Manifest Check

            This PR modifies files that may affect app store privacy declarations.

            ### Changes detected:
            ${changes}

            ### Action required:
            1. Review [Planning/PRIVACY_MANIFEST.md](../blob/main/Planning/PRIVACY_MANIFEST.md) to ensure it reflects current data collection
            2. If data collection changed, update:
               - **Apple:** [App Store Connect → App Privacy](https://appstoreconnect.apple.com)
               - **Google:** [Play Console → Data Safety](https://play.google.com/console)
            3. Add a row to the Change Log in PRIVACY_MANIFEST.md

            _This comment was added automatically by the privacy-manifest-check workflow._`;

            // Check for existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c =>
              c.body && c.body.includes('Privacy Manifest Check') &&
              c.user && c.user.type === 'Bot'
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
