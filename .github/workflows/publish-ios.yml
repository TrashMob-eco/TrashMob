name: Publish iOS app

on:
    workflow_call:
        inputs:
            artifact_name:
                required: true
                type: string
            environment:
                required: true
                type: string
        secrets:
            APPSTORE_ISSUER_ID:
                required: true
            APPSTORE_API_KEY_ID:
                required: true
            APPSTORE_API_PRIVATE_KEY:
                required: true


jobs:
    deploy-ios:
        name: Deploy iOS to TestFlight
        runs-on: macos-14
        environment: ${{ inputs.environment }}
        steps:
            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                    name: ${{ inputs.artifact_name }}

            - name: Get ipa filename
              run: echo "IPA_FILENAME=$(ls -R *.ipa)" > $GITHUB_ENV

            - name: Install API key and upload to TestFlight
              run: |
                # Write the private key to the expected location
                mkdir -p ~/private_keys
                echo "$API_PRIVATE_KEY" > ~/private_keys/AuthKey_${API_KEY_ID}.p8

                # Verify the key file
                echo "Key file size: $(wc -c < ~/private_keys/AuthKey_${API_KEY_ID}.p8)"
                echo "Key file lines: $(wc -l < ~/private_keys/AuthKey_${API_KEY_ID}.p8)"
                echo "Key file permissions: $(ls -la ~/private_keys/AuthKey_${API_KEY_ID}.p8)"

                # Check iTMSTransporter version
                xcrun iTMSTransporter -version || true

                # Run the upload
                xcrun iTMSTransporter \
                  -m upload \
                  -assetFile "$IPA_FILENAME" \
                  -apiKey "$API_KEY_ID" \
                  -apiIssuer "$API_ISSUER_ID" \
                  -v eXtreme \
                  -appPlatform ios 2>&1 || {
                    echo "---"
                    echo "iTMSTransporter failed. Checking key file content structure..."
                    echo "First line: $(head -1 ~/private_keys/AuthKey_${API_KEY_ID}.p8)"
                    echo "Last line: $(tail -1 ~/private_keys/AuthKey_${API_KEY_ID}.p8)"
                    echo "File hex dump (first 100 bytes):"
                    xxd -l 100 ~/private_keys/AuthKey_${API_KEY_ID}.p8
                    exit 1
                  }

                # Cleanup
                rm -rf ~/private_keys
              env:
                API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
                API_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
                API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
                IPA_FILENAME: ${{ env.IPA_FILENAME }}
