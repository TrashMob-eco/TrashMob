name: Publish iOS app

on:
    workflow_call:
        inputs:
            artifact_name:
                required: true
                type: string
            environment:
                required: true
                type: string
        secrets:
            APPSTORE_ISSUER_ID:
                required: true
            APPSTORE_API_KEY_ID:
                required: true
            APPSTORE_API_PRIVATE_KEY:
                required: true


jobs:
    deploy-ios:
        name: Deploy iOS to TestFlight
        runs-on: macos-14
        environment: ${{ inputs.environment }}
        steps:
            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                    name: ${{ inputs.artifact_name }}

            - name: Get ipa filename
              run: echo "IPA_FILENAME=$(ls -R *.ipa)" > $GITHUB_ENV

            - name: Debug key format
              run: |
                echo "Key ID length: ${#KEY_ID}"
                echo "Issuer ID length: ${#ISSUER_ID}"
                echo "Private key length: ${#PRIVATE_KEY}"
                echo "Private key starts with BEGIN: $(echo "$PRIVATE_KEY" | head -1 | grep -c 'BEGIN')"
                echo "Private key ends with END: $(echo "$PRIVATE_KEY" | tail -1 | grep -c 'END')"
                echo "Private key line count: $(echo "$PRIVATE_KEY" | wc -l)"
              env:
                KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
                ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
                PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}

            - name: Unlock keychain
              run: security unlock-keychain -p "" ~/Library/Keychains/login.keychain-db || true

            - name: Upload signed IPA
              uses: apple-actions/upload-testflight-build@v4
              with:
                    app-path: ${{ env.IPA_FILENAME }}
                    issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
                    api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
                    api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
