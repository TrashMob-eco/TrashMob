# TrashMob Fastlane Configuration
#
# Lanes:
#   iOS:
#     ios_upload       — Upload IPA to TestFlight (replaces xcrun altool)
#     ios_submit       — Submit latest TestFlight build for App Store review
#     ios_screenshots  — Frame and upload screenshots to App Store Connect
#   Android:
#     android_promote  — Promote from internal track to production with staged rollout
#     android_rollout  — Update rollout percentage for production track

default_platform(:ios)

# Screenshot ordering — controls display order in App Store listing.
# Each entry maps a sequential prefix to the source filename (without extension).
SCREENSHOT_ORDER = %w[
  welcome
  home
  explore
  createevent
  login
  impact
  profile
  locationpreference
  reportlitter
].freeze

# ── iOS Lanes ──────────────────────────────────────────────────

platform :ios do
  before_all do
    # Configure App Store Connect API key from environment
    if ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"]
      app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
        is_key_content_base64: false,
        in_house: false
      )
    end
  end

  desc "Upload IPA to TestFlight"
  lane :ios_upload do |options|
    ipa_path = options[:ipa] || Dir["*.ipa"].first

    UI.user_error!("No IPA file found") unless ipa_path && File.exist?(ipa_path)
    UI.message("Uploading #{ipa_path} to TestFlight...")

    pilot(
      ipa: ipa_path,
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false
    )
  end

  desc "Frame and upload screenshots to App Store Connect"
  lane :ios_screenshots do
    prepare_screenshots
    apply_frames
    upload_screenshots
  end

  desc "Submit latest TestFlight build for App Store review"
  lane :ios_submit do |options|
    build_number = options[:build_number]

    prepare_screenshots
    apply_frames

    deliver(
      app_identifier: ENV["IOS_BUNDLE_ID"] || "eco.trashmob",
      skip_binary_upload: true,
      submit_for_review: true,
      automatic_release: false,
      force: true, # Skip HTML preview in CI
      precheck_include_in_app_purchases: false,
      screenshots_path: "screenshots",
      overwrite_screenshots: true,
      submission_information: {
        add_id_info_uses_idfa: false
      },
      build_number: build_number
    )
  end

  # ── Private helpers ──────────────────────────────────────────

  private_lane :prepare_screenshots do
    # Fastlane runs from the fastlane/ directory, so use ../ to reach repo root
    screenshots_dir = "screenshots/en-US"
    assets_dir = "../Planning/StoreAssets/Screenshots"

    # Clean staging directory
    Dir.glob("#{screenshots_dir}/*.png").each { |f| File.delete(f) }

    # Copy screenshots with sequential prefixes for ordering
    %w[iPhone_6.9 iPad_13].each do |device_dir|
      source_dir = "#{assets_dir}/#{device_dir}"
      UI.user_error!("Screenshot source not found: #{source_dir}") unless Dir.exist?(source_dir)

      SCREENSHOT_ORDER.each_with_index do |name, index|
        src = "#{source_dir}/#{name}.png"
        next unless File.exist?(src)

        prefix = format("%02d", index + 1)
        dest = "#{screenshots_dir}/#{device_dir}_#{prefix}_#{name}.png"
        FileUtils.cp(src, dest)
        UI.message("Copied #{src} → #{dest}")
      end
    end

    screenshot_count = Dir.glob("#{screenshots_dir}/*.png").length
    UI.message("Prepared #{screenshot_count} screenshots for upload")
    UI.user_error!("No screenshots found — check Planning/StoreAssets/Screenshots/") if screenshot_count == 0
  end

  private_lane :apply_frames do
    # frameit uses Dir.chdir internally, which resolves from the process
    # working directory (repo root), not fastlane's directory
    frameit(
      path: "fastlane/screenshots/en-US",
      force_device_type: nil
    )
  end

  private_lane :upload_screenshots do
    deliver(
      app_identifier: ENV["IOS_BUNDLE_ID"] || "eco.trashmob",
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: false,
      screenshots_path: "screenshots",
      overwrite_screenshots: true,
      force: true,
      submit_for_review: false,
      run_precheck_before_submit: false
    )
  end
end

# ── Android Lanes ──────────────────────────────────────────────

platform :android do
  desc "Promote from internal track to production with staged rollout"
  lane :android_promote do |options|
    package_name = options[:package_name] || ENV["ANDROID_BUNDLE_ID"] || "eco.trashmob.trashmobmobileapp"
    rollout = (options[:rollout] || 0.1).to_f

    UI.message("Promoting #{package_name} from internal → production at #{(rollout * 100).to_i}% rollout")

    supply(
      package_name: package_name,
      track: "internal",
      track_promote_to: "production",
      rollout: rollout.to_s,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Update rollout percentage for production track"
  lane :android_rollout do |options|
    package_name = options[:package_name] || ENV["ANDROID_BUNDLE_ID"] || "eco.trashmob.trashmobmobileapp"
    rollout = options[:rollout].to_f

    UI.user_error!("rollout must be between 0 and 1") unless rollout > 0 && rollout <= 1

    if rollout >= 1.0
      UI.message("Completing rollout for #{package_name} (100%)")
    else
      UI.message("Updating #{package_name} production rollout to #{(rollout * 100).to_i}%")
    end

    supply(
      package_name: package_name,
      track: "production",
      rollout: rollout.to_s,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end
end
