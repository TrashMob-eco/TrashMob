<?xml version="1.0" encoding="utf-8" ?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:maps="http://schemas.microsoft.com/dotnet/2021/maui/maps"
             xmlns:viewModels="clr-namespace:TrashMobMobile.ViewModels"
             xmlns:controls="clr-namespace:TrashMobMobile.Controls"
             x:DataType="viewModels:ExploreViewModel"
             x:Class="TrashMobMobile.Pages.ExplorePage"
             Title="Explore">

    <Grid RowDefinitions="Auto, Auto, Auto, Auto, *">

        <!-- Row 0: Layer checkboxes -->
        <Grid Grid.Row="0" ColumnDefinitions="Auto, Auto, Auto, Auto, *" Margin="10,4,10,0">
            <CheckBox Grid.Column="0" IsChecked="{Binding ShowEvents, Mode=TwoWay}"
                      Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
            <Label Grid.Column="1" Text="Events" FontSize="Small" VerticalOptions="Center" Margin="-4,0,8,0"
                   TextColor="{AppThemeBinding Light={StaticResource ContentPrimary}, Dark={StaticResource ContentPrimaryDark}}" />
            <CheckBox Grid.Column="2" IsChecked="{Binding ShowLitterReports, Mode=TwoWay}"
                      Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
            <Label Grid.Column="3" Text="Litter Reports" FontSize="Small" VerticalOptions="Center" Margin="-4,0,0,0"
                   TextColor="{AppThemeBinding Light={StaticResource ContentPrimary}, Dark={StaticResource ContentPrimaryDark}}" />
        </Grid>

        <!-- Row 1: Location pickers -->
        <Grid Grid.Row="1" ColumnDefinitions="*, *, *, Auto" Margin="5,0">
            <controls:TMPicker Grid.Column="0" Title="Country"
                               ItemsSource="{Binding CountryCollection}"
                               SelectedItem="{Binding SelectedCountry, Mode=TwoWay}" />
            <controls:TMPicker Grid.Column="1" Title="Region"
                               ItemsSource="{Binding RegionCollection}"
                               SelectedItem="{Binding SelectedRegion, Mode=TwoWay}" />
            <controls:TMPicker Grid.Column="2" Title="City"
                               ItemsSource="{Binding CityCollection}"
                               SelectedItem="{Binding SelectedCity, Mode=TwoWay}" />
            <ImageButton Grid.Column="3"
                         HeightRequest="24"
                         WidthRequest="24"
                         Command="{Binding ClearSelectionsCommand}"
                         Source="{FontImageSource FontFamily=GoogleMaterialIcons, Glyph={DynamicResource IconClose}, Color={AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDarkText}}}" />
        </Grid>

        <!-- Row 2: Status filters with RadioButtons -->
        <VerticalStackLayout Grid.Row="2" Spacing="0">

            <!-- Event status filters -->
            <VerticalStackLayout IsVisible="{Binding ShowEvents}" Spacing="0">
                <Label Text="Events" FontFamily="LexendSemibold" FontSize="Micro" Margin="12,4,0,0"
                       TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                <HorizontalStackLayout Spacing="0" Margin="10,0"
                      RadioButtonGroup.GroupName="EventFilter"
                      RadioButtonGroup.SelectedValue="{Binding EventFilterSelection, Mode=TwoWay}">
                    <RadioButton Content="Upcoming" Value="Upcoming" />
                    <RadioButton Content="Completed" Value="Completed" />
                </HorizontalStackLayout>
                <controls:TMPicker Margin="10,0"
                                   IsVisible="{Binding IsUpcomingSelected}"
                                   Title="Date Range"
                                   ItemsSource="{Binding UpcomingDateRanges}"
                                   SelectedItem="{Binding SelectedUpcomingDateRange, Mode=TwoWay}" />
                <controls:TMPicker Margin="10,0"
                                   IsVisible="{Binding IsCompletedSelected}"
                                   Title="Date Range"
                                   ItemsSource="{Binding CompletedDateRanges}"
                                   SelectedItem="{Binding SelectedCompletedDateRange, Mode=TwoWay}" />
            </VerticalStackLayout>

            <!-- Litter report status filters -->
            <VerticalStackLayout IsVisible="{Binding ShowLitterReports}" Spacing="0">
                <Label Text="Litter Reports" FontFamily="LexendSemibold" FontSize="Micro" Margin="12,4,0,0"
                       TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                <HorizontalStackLayout Spacing="0" Margin="10,0"
                      RadioButtonGroup.GroupName="LitterFilter"
                      RadioButtonGroup.SelectedValue="{Binding LitterFilterSelection, Mode=TwoWay}">
                    <RadioButton Content="New" Value="New" />
                    <RadioButton Content="Assigned" Value="Assigned" />
                    <RadioButton Content="Cleaned" Value="Cleaned" />
                </HorizontalStackLayout>
                <controls:TMPicker Margin="10,0"
                                   Title="Created Date Range"
                                   ItemsSource="{Binding CreatedDateRanges}"
                                   SelectedItem="{Binding SelectedCreatedDateRange, Mode=TwoWay}" />
            </VerticalStackLayout>
        </VerticalStackLayout>

        <!-- Row 3: Map/List toggle bar right above content -->
        <Grid Grid.Row="3" ColumnDefinitions="*, Auto, Auto" Margin="5,2">
            <ImageButton Grid.Column="1"
                         HeightRequest="24"
                         Source="{FontImageSource FontFamily=GoogleMaterialIcons, Glyph={DynamicResource IconMap}, Color={AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDarkText}}}"
                         Command="{Binding MapSelectedCommand}" />
            <ImageButton Grid.Column="2"
                         HeightRequest="24"
                         Source="{FontImageSource FontFamily=GoogleMaterialIcons, Glyph={DynamicResource IconViewList}, Color={AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDarkText}}}"
                         Command="{Binding ListSelectedCommand}" />
        </Grid>

        <!-- Map View -->
        <controls:CustomMap Grid.Row="4"
                            x:Name="exploreMap"
                            ItemsSource="{Binding Addresses}"
                            IsVisible="{Binding IsMapSelected}"
                            HeightRequest="-1"
                            VerticalOptions="Fill">
            <maps:Map.ItemTemplate>
                <DataTemplate x:DataType="viewModels:AddressViewModel">
                    <controls:CustomPin Location="{Binding Location}"
                                        Address="{Binding StreetAddress}"
                                        Label="{Binding DisplayName}"
                                        AutomationId="{Binding AutomationId}"
                                        ImageSource="{Binding IconFile}"
                                        InfoWindowClicked="Pin_InfoWindowClicked" />
                </DataTemplate>
            </maps:Map.ItemTemplate>
        </controls:CustomMap>

        <!-- List View -->
        <ScrollView Grid.Row="4" IsVisible="{Binding IsListSelected}">
            <VerticalStackLayout>
                <Label Text="No results found"
                       IsVisible="{Binding AreNoItemsFound}"
                       FontSize="Small"
                       Margin="10,20"
                       HorizontalTextAlignment="Center"
                       TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />

                <!-- Events List -->
                <VerticalStackLayout IsVisible="{Binding ShowEvents}">
                    <Label Text="Events"
                           FontFamily="LexendSemibold"
                           FontSize="Small"
                           Margin="10,10,10,5"
                           IsVisible="{Binding ShowLitterReports}" />
                    <CollectionView ItemsSource="{Binding Events}"
                                    SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="viewModels:EventViewModel">
                                <Border Style="{x:StaticResource RoundBorder}" Margin="5,3">
                                    <VerticalStackLayout Padding="10,8" Spacing="2">
                                        <HorizontalStackLayout Spacing="6">
                                            <Label Text="{Binding Name}" FontFamily="LexendSemibold" FontSize="Small" />
                                            <Label Text="{Binding EventVisibilityText}" FontSize="Micro"
                                                   TextColor="{StaticResource Primary}"
                                                   VerticalOptions="Center">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label" Binding="{Binding EventVisibilityText}" Value="Public">
                                                        <Setter Property="IsVisible" Value="False" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>
                                        </HorizontalStackLayout>
                                        <Label Text="{Binding DisplayDate}" FontSize="Micro"
                                               TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                                        <Label Text="{Binding Address.DisplayAddress}" FontSize="Micro"
                                               TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                                    </VerticalStackLayout>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:ExploreViewModel}}, Path=ViewEventCommand}"
                                            CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <!-- Litter Reports List -->
                <VerticalStackLayout IsVisible="{Binding ShowLitterReports}">
                    <Label Text="Litter Reports"
                           FontFamily="LexendSemibold"
                           FontSize="Small"
                           Margin="10,10,10,5"
                           IsVisible="{Binding ShowEvents}" />
                    <CollectionView ItemsSource="{Binding LitterReports}"
                                    SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="viewModels:LitterReportViewModel">
                                <Border Style="{x:StaticResource RoundBorder}" Margin="5,3">
                                    <Grid ColumnDefinitions="*, Auto" Padding="10,8">
                                        <VerticalStackLayout Grid.Column="0" Spacing="2">
                                            <Label Text="{Binding Name}" FontFamily="LexendSemibold" FontSize="Small" />
                                            <Label Text="{Binding LitterReportStatus}" FontSize="Micro"
                                                   TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                                        </VerticalStackLayout>
                                        <Border Grid.Column="1"
                                                StrokeShape="RoundRectangle 6"
                                                StrokeThickness="0"
                                                IsVisible="{Binding HasThumbnail}"
                                                WidthRequest="56"
                                                HeightRequest="56"
                                                VerticalOptions="Center">
                                            <Image Source="{Binding ThumbnailUrl}"
                                                   Aspect="AspectFill"
                                                   WidthRequest="56"
                                                   HeightRequest="56" />
                                        </Border>
                                    </Grid>
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:ExploreViewModel}}, Path=ViewLitterReportCommand}"
                                            CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </VerticalStackLayout>
        </ScrollView>

        <!-- Loading Overlay -->
        <BoxView Grid.Row="4"
                 BackgroundColor="{StaticResource TransparentBlack}"
                 IsVisible="{Binding IsBusy}" />
        <ActivityIndicator Grid.Row="4"
                           IsRunning="{Binding IsBusy}"
                           IsVisible="{Binding IsBusy}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center" />
    </Grid>
</ContentPage>
