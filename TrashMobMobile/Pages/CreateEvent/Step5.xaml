<?xml version="1.0" encoding="utf-8"?>

<createEvent:BaseStepClass xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
                           xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
                           xmlns:createEvent="clr-namespace:TrashMobMobile.Pages.CreateEvent"
                           xmlns:viewModels="clr-namespace:TrashMobMobile.ViewModels"
                           x:DataType="viewModels:CreateEventViewModel"
                           xmlns:maps="http://schemas.microsoft.com/dotnet/2021/maui/maps"
                           xmlns:controls="clr-namespace:TrashMobMobile.Controls"
                           x:Class="TrashMobMobile.Pages.CreateEvent.Step5">
    <ScrollView>
        <Grid>
            <VerticalStackLayout Spacing="0" Padding="0,4">

                <!-- No Litter Reports Empty State -->
                <Border Style="{StaticResource RoundBorder}" Margin="4,4"
                        IsVisible="{Binding AreNoLitterReportsAvailable}">
                    <VerticalStackLayout Spacing="12" HorizontalOptions="Center" Padding="0,20">
                        <Image MaximumWidthRequest="48" MaximumHeightRequest="48" HorizontalOptions="Center">
                            <Image.Source>
                                <FontImageSource FontFamily="{StaticResource GoogleMaterialIcons}"
                                                 Glyph="{StaticResource IconTrashCanOutline}"
                                                 Size="48"
                                                 Color="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                            </Image.Source>
                        </Image>
                        <Label Text="No Litter Reports Nearby"
                               FontFamily="LexendSemibold"
                               FontSize="Small"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                        <Label Text="There are currently no litter reports in the area of your event."
                               FontSize="Micro"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                    </VerticalStackLayout>
                </Border>

                <!-- Content when litter reports exist -->
                <VerticalStackLayout Spacing="0"
                                     IsVisible="{Binding AreLitterReportsAvailable}">

                    <!-- Header with instruction -->
                    <VerticalStackLayout Spacing="4" Margin="12,8,12,4">
                        <HorizontalStackLayout Spacing="8">
                            <Image MaximumWidthRequest="20" MaximumHeightRequest="20" VerticalOptions="Center">
                                <Image.Source>
                                    <FontImageSource FontFamily="{StaticResource GoogleMaterialIcons}"
                                                     Glyph="{StaticResource IconTrashCanOutline}"
                                                     Size="20"
                                                     Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                                </Image.Source>
                            </Image>
                            <Label Text="Nearby Litter Reports"
                                   FontFamily="LexendSemibold"
                                   FontSize="Medium"
                                   VerticalOptions="Center" />
                        </HorizontalStackLayout>
                        <Label Text="Add a nearby litter report to your event for your team to clean!"
                               FontSize="Micro"
                               Margin="28,0,0,0"
                               TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                    </VerticalStackLayout>

                    <!-- Map/List Toggle -->
                    <Border Style="{StaticResource RoundBorder}" Margin="4,4" Padding="4">
                        <Grid ColumnDefinitions="*, *" ColumnSpacing="4">
                            <Button Grid.Column="0"
                                    Text="Map View"
                                    Command="{Binding MapSelectedCommand}"
                                    Style="{StaticResource PrimarySmallButton}"
                                    ContentLayout="Left, 8"
                                    ImageSource="{FontImageSource FontFamily=GoogleMaterialIcons, Glyph={DynamicResource IconMap}, Size=16, Color={AppThemeBinding Light={StaticResource PrimaryReverseText}, Dark={StaticResource PrimaryDarkReverseText}}}" />
                            <Button Grid.Column="1"
                                    Text="List View"
                                    Command="{Binding ListSelectedCommand}"
                                    Style="{StaticResource SecondarySmallButton}"
                                    ContentLayout="Left, 8"
                                    ImageSource="{FontImageSource FontFamily=GoogleMaterialIcons, Glyph={DynamicResource IconViewList}, Size=16, Color={AppThemeBinding Light={StaticResource SecondaryText}, Dark={StaticResource SecondaryDarkText}}}" />
                        </Grid>
                    </Border>

                    <!-- Map -->
                    <Border StrokeShape="RoundRectangle 10"
                            StrokeThickness="0"
                            Padding="0"
                            Margin="4,4"
                            IsVisible="{Binding IsLitterReportMapSelected}">
                        <controls:CustomMap x:Name="litterImagesMap"
                                            ItemsSource="{Binding LitterImages}"
                                            HeightRequest="300">
                            <maps:Map.ItemTemplate>
                                <DataTemplate x:DataType="viewModels:LitterImageViewModel">
                                    <controls:CustomPin Location="{Binding Address.Location}"
                                                        Address="{Binding Address.StreetAddress}"
                                                        Label="{Binding Address.StreetAddress}"
                                                        AutomationId="{Binding LitterReportId}"
                                                        ImageSource="{Binding Address.IconFile}"
                                                        InfoWindowClicked="Pin_InfoWindowClicked" />
                                </DataTemplate>
                            </maps:Map.ItemTemplate>
                        </controls:CustomMap>
                    </Border>

                    <!-- List -->
                    <CollectionView x:Name="LitterReportsCollection"
                                    ItemsSource="{Binding EventLitterReports}"
                                    IsVisible="{Binding IsLitterReportListSelected}"
                                    SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="viewModels:EventLitterReportViewModel">
                                <Border Style="{StaticResource RoundBorder}" Margin="4,4">
                                    <VerticalStackLayout Spacing="8">
                                        <!-- Name -->
                                        <Label Text="{Binding Name}"
                                               FontFamily="LexendSemibold"
                                               FontSize="Small"
                                               LineBreakMode="WordWrap" />

                                        <!-- Date & Status row -->
                                        <Grid ColumnDefinitions="*, *" ColumnSpacing="12">
                                            <VerticalStackLayout Grid.Column="0" Spacing="2">
                                                <Label Text="Date Created" Style="{StaticResource FieldLabel}"
                                                       TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                                                <Label Text="{Binding CreatedDate}" FontSize="Micro" />
                                            </VerticalStackLayout>
                                            <VerticalStackLayout Grid.Column="1" Spacing="2">
                                                <Label Text="Status" Style="{StaticResource FieldLabel}"
                                                       TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                                                <Label Text="{Binding Status}" FontSize="Micro" />
                                            </VerticalStackLayout>
                                        </Grid>

                                        <!-- Description -->
                                        <VerticalStackLayout Spacing="2">
                                            <Label Text="Description" Style="{StaticResource FieldLabel}"
                                                   TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                                            <Label Text="{Binding Description}" FontSize="Micro" LineBreakMode="WordWrap" />
                                        </VerticalStackLayout>

                                        <!-- Action Buttons -->
                                        <Grid ColumnDefinitions="*, *" ColumnSpacing="8">
                                            <Button Text="Add to Event"
                                                    Command="{Binding AddToEventCommand}"
                                                    IsVisible="{Binding CanAddToEvent}"
                                                    Style="{StaticResource PrimarySmallButton}"
                                                    Grid.Column="0"
                                                    ContentLayout="Left, 8"
                                                    ImageSource="{FontImageSource FontFamily=GoogleMaterialIcons, Glyph={DynamicResource IconPlusCircle}, Size=16, Color={AppThemeBinding Light={StaticResource PrimaryReverseText}, Dark={StaticResource PrimaryDarkReverseText}}}" />
                                            <Button Text="Remove"
                                                    Command="{Binding RemoveFromEventCommand}"
                                                    IsVisible="{Binding CanRemoveFromEvent}"
                                                    Style="{StaticResource SecondarySmallButton}"
                                                    Grid.Column="1"
                                                    ContentLayout="Left, 8"
                                                    ImageSource="{FontImageSource FontFamily=GoogleMaterialIcons, Glyph={DynamicResource IconDelete}, Size=16, Color={AppThemeBinding Light={StaticResource SecondaryText}, Dark={StaticResource SecondaryDarkText}}}" />
                                        </Grid>

                                        <!-- Locations -->
                                        <VerticalStackLayout Spacing="4">
                                            <Label Text="Locations" Style="{StaticResource FieldLabel}"
                                                   TextColor="{AppThemeBinding Light={StaticResource MutedForegroundLight}, Dark={StaticResource MutedForegroundDark}}" />
                                            <CollectionView ItemsSource="{Binding LitterImageViewModels}">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate x:DataType="viewModels:LitterImageViewModel">
                                                        <Border Padding="8"
                                                                Margin="0,2"
                                                                StrokeShape="RoundRectangle 8"
                                                                BackgroundColor="{AppThemeBinding Light={StaticResource PageBackgroundLight}, Dark={StaticResource PageBackgroundDark}}"
                                                                Stroke="{AppThemeBinding Light={StaticResource BorderLight}, Dark={StaticResource BorderDark}}"
                                                                StrokeThickness="1">
                                                            <Grid ColumnDefinitions="*, Auto" ColumnSpacing="8">
                                                                <Label Text="{Binding Address.DisplayAddress}"
                                                                       Grid.Column="0"
                                                                       LineBreakMode="WordWrap"
                                                                       FontSize="Micro"
                                                                       VerticalOptions="Center" />
                                                                <Border Grid.Column="1"
                                                                        StrokeShape="RoundRectangle 6"
                                                                        StrokeThickness="0"
                                                                        Padding="0"
                                                                        WidthRequest="56"
                                                                        HeightRequest="56">
                                                                    <Image Source="{Binding AzureBlobUrl}"
                                                                           Aspect="AspectFill" />
                                                                </Border>
                                                            </Grid>
                                                        </Border>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>
                                        </VerticalStackLayout>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>

                <BoxView HeightRequest="12" BackgroundColor="Transparent" />

            </VerticalStackLayout>
            <BoxView BackgroundColor="{StaticResource TransparentBlack}" HorizontalOptions="Fill"
                     VerticalOptions="Fill" IsVisible="{Binding IsBusy}" />
            <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" VerticalOptions="Center"
                               HorizontalOptions="Center" />
        </Grid>
    </ScrollView>
</createEvent:BaseStepClass>